---
layout: mongodb
title: MongoDB备份数据
date: 2018-06-16 18:58:47
tags: 
- MongoDB
categories: 
- 服务器
- 数据库
- MongoDB
---

# mongoDB 备份数据


mongodump 是 MongoDB 提供的一个工具，用于备份数据库，配合使用 mongorestore 恢复工具使用。这套工具适合小型应用或开发环境。

运行 mongodump 和 mongorestore 时需要读取正在运行的数据库实例，因此会影响数据库性能。一方面是运行时需要占用系统资源，另一方面，运行这两个命令时数据库会强制通过内存读取所有数据，可能导致读取的不常用数据覆盖常用数据，从而影响数据库日常运行的性能。
2.2及以上版本的 mongodump 数据格式与低版本不兼容，因此请勿使用高版本工具备份低版本数据。
mongodump 不会备份 local 数据库。

直接运行 mongodump 命令，默认备份本地运行在27017端口下的 MongoDB 实例中的所有数据库（local 除外），并在当前目录下生成 dump/ 路径存放备份文件。
你也可以使用以下命令指定备份的数据库位置、端口、输出文件位置、备份数据库和文档：

### 语法如下

```
> mongodump -h dbhost -d dbname -o dbdirectory -u user -p password
```
* -h MongDB所在服务器地址，例如：127.0.0.1，当然也可以指定端口号：127.0.0.1:27017
* -d 需要备份的数据库实例，例如：test
* -o 备份的数据存放位置，例如：c:datadump，当然该目录需要提前建立，在备份完成后，系统自动在dump目录下建立一个test目录，这个目录里面存放该数据库实例的备份数据。
* -u -p 如果有设置用户和密码，需要设置对应的用户名和密码，否则没有权限

## 一、编写脚本

```
#!/bin/sh
# dump 命令执行路径，根据mongodb安装路径而定
DUMP=/usr/bin/mongodump
# 临时备份路径
OUT_DIR=/home/backup/mongod_bak/mongod_bak_now
# 压缩后的备份存放路径
TAR_DIR=/home/backup/mongod_bak/mongod_bak_list
# 当前系统时间
DATE=`date +%Y-%m-%d`
# 数据库账号
DB_USER=user
# 数据库密码
DB_PASS=password
# 代表删除7天前的备份，即只保留近 7 天的备份
DAYS=7
# 最终保存的数据库备份文件
TAR_BAK="mongod_bak_$DATE.tar.gz"
cd $OUT_DIR
rm -rf $OUT_DIR/*
mkdir -p $OUT_DIR/$DATE
$DUMP -h 127.0.0.1:27017 -u $DB_USER -p $DB_PASS -d dbname -o $OUT_DIR/$DATE
# 压缩格式为 .tar.gz 格式
tar -zcvf $TAR_DIR/$TAR_BAK $OUT_DIR/$DATE
# 删除 15 天前的备份文件
find $TAR_DIR/ -mtime +$DAYS -delete

exit
```
## 二、创建对应的目录

```
mkdir /home/backup/mongod_bak/mongod_bak_now
mkdir /home/backup/mongod_bak/mongod_bak_list
```
## 三、设置只执行

```
chmod +x mongod_bak.sh
```
## 四、利用系统工具定期执行命令

```
vim /etc/crontab
```
如果没有这个文件 我的是docker容器

```
apt-get install cron
```
在底部添加

```
0 2 * * * root ~/crontab/mongod_bak.sh
```
基本格式 :
command
分　时　日　月　周　命令

第1列表示分钟1～59 每分钟用或者 /1表示
第2列表示小时1～23（0表示0点）
第3列表示日期1～31
第4列表示月份1～12
第5列标识号星期0～6（0表示星期天）

示例：

```
# m h dom mon dow user	command
17 *	* * *	root cd / && run-parts --report /etc/cron.hourly
25 6	* * *	root	test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6	* * 7	root	test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6	1 * *	root	test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
*  18    * * *   root    cd /data/mongodb_time_bak/ && ./mongodb_bak.sh

```

## 五、开启定时服务

```
service crond start
```


