---
title: AIDL基础复习
date: 2017-09-23 15:36:17
tags: 
- AIDL
categories: 
- Android
- 基础知识
---

## AIDL

#### 1、创建AIDL:实体对象、新建AIDL文件、make工程

![1549854299989](assets/1549854299989.png)

#### 2、服务端：新建Binder对象、定义方法
``` java
// 包名需要和原始类的一样
parcelable Person;

interface IMyAidl {
    void addPerson(in Person person);

    List<Person> getPersonList();

}
```
#### 3、客户端：实现serviceConnection、BindService

``` java

public class MyAidlService extends Service {
    private final String TAG = this.getClass().getSimpleName();
    private ArrayList<Person> mPersons;
    /**
     * 创建生成的本地 Binder 对象，实现 AIDL 制定的方法
     */
    private IBinder mIBinder = new IMyAidl.Stub() {
        @Override
        public void addPerson(Person person) throws RemoteException {
            mPersons.add(person);
        }
        @Override
        public List<Person> getPersonList() throws RemoteException {
            return mPersons;
        }
    };

    /**
     * 客户端与服务端绑定时的回调，返回 mIBinder 后客户端就可以通过它远程调用服务端的方法，即实现了通讯
     *
     * @param intent
     * @return
     */
    @Nullable
    @Override
    public IBinder onBind(Intent intent) {
        mPersons = new ArrayList<>();
        Log.d(TAG, "MyAidlService onBind");
        return mIBinder;
    }
```

``` java
public class MyServiceActivity extends Activity {
    private Button mBtn;
    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        mBtn = findViewById(R.id.btn);
        mBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                Intent intent1 = new Intent(getApplicationContext(), MyAidlService.class);
                bindService(intent1, mConnection, BIND_AUTO_CREATE);
                addPerson();
            }
        });

    }

    private IMyAidl mAidl;
    private ServiceConnection mConnection = new ServiceConnection() {
        @Override
        public void onServiceConnected(ComponentName name, IBinder service) {
            //连接后拿到 Binder，转换成 AIDL，在不同进程会返回个代理
            //获取到远端的Binder 进行操作
            mAidl = IMyAidl.Stub.asInterface(service);
        }
        @Override
        public void onServiceDisconnected(ComponentName name) {
            mAidl = null;
        }
    };
    List<Person> personList;
    public void addPerson() {
        Random random = new Random();
        Person person = new Person("shixin" + random.nextInt(10));
        try {
            mAidl.addPerson(person);
            personList = mAidl.getPersonList();
        } catch (RemoteException e) {
            e.printStackTrace();
        }
    }
}

```
Aidl生成类
``` java 
public interface IMyAidl extends IInterface {
    void addPerson(Person var1) throws RemoteException;

    List<Person> getPersonList() throws RemoteException;

    public abstract static class Stub extends Binder implements IMyAidl {
        private static final String DESCRIPTOR = "com.example.jiajiemu.test.IMyAidl";
        static final int TRANSACTION_addPerson = 1;
        static final int TRANSACTION_getPersonList = 2;

        public Stub() {
            this.attachInterface(this, "com.example.jiajiemu.test.IMyAidl");
        }

        public static IMyAidl asInterface(IBinder obj) {
            if (obj == null) {
                return null;
            } else {
                IInterface iin = obj.queryLocalInterface("com.example.jiajiemu.test.IMyAidl");
                return (IMyAidl)(iin != null && iin instanceof IMyAidl ? (IMyAidl)iin : new IMyAidl.Stub.Proxy(obj));
            }
        }

        public IBinder asBinder() {
            return this;
        }

        public boolean onTransact(int code, Parcel data, Parcel reply, int flags) throws RemoteException {
            switch(code) {
            case 1:
                data.enforceInterface("com.example.jiajiemu.test.IMyAidl");
                Person _arg0;
                if (0 != data.readInt()) {
                    _arg0 = (Person)Person.CREATOR.createFromParcel(data);
                } else {
                    _arg0 = null;
                }

                this.addPerson(_arg0);
                reply.writeNoException();
                return true;
            case 2:
                data.enforceInterface("com.example.jiajiemu.test.IMyAidl");
                List<Person> _result = this.getPersonList();
                reply.writeNoException();
                reply.writeTypedList(_result);
                return true;
            case 1598968902:
                reply.writeString("com.example.jiajiemu.test.IMyAidl");
                return true;
            default:
                return super.onTransact(code, data, reply, flags);
            }
        }

        private static class Proxy implements IMyAidl {
            private IBinder mRemote;

            Proxy(IBinder remote) {
                this.mRemote = remote;
            }

            public IBinder asBinder() {
                return this.mRemote;
            }

            public String getInterfaceDescriptor() {
                return "com.example.jiajiemu.test.IMyAidl";
            }

            public void addPerson(Person person) throws RemoteException {
                Parcel _data = Parcel.obtain();
                Parcel _reply = Parcel.obtain();

                try {
                    _data.writeInterfaceToken("com.example.jiajiemu.test.IMyAidl");
                    if (person != null) {
                        _data.writeInt(1);
                        person.writeToParcel(_data, 0);
                    } else {
                        _data.writeInt(0);
                    }

                    this.mRemote.transact(1, _data, _reply, 0);
                    _reply.readException();
                } finally {
                    _reply.recycle();
                    _data.recycle();
                }

            }

            public List<Person> getPersonList() throws RemoteException {
                Parcel _data = Parcel.obtain();
                Parcel _reply = Parcel.obtain();

                ArrayList _result;
                try {
                    _data.writeInterfaceToken("com.example.jiajiemu.test.IMyAidl");
                    this.mRemote.transact(2, _data, _reply, 0);
                    _reply.readException();
                    _result = _reply.createTypedArrayList(Person.CREATOR);
                } finally {
                    _reply.recycle();
                    _data.recycle();
                }

                return _result;
            }
        }
    }
}

```