---
title: H.264编码简介
tags:
  - H264
  - 视频编码
categories:
  - 视频
abbrlink: 54217
date: 2018-11-28 22:21:21
---


## H.264

![](http://image.sweetm.top//18-6-26/24466101.jpg)


## H.264编码简介
---
H.264原始码流（又称为“裸流”）是由一个一个的NALU组成的。他们的结构如下图所示。

* 视频编码层（VCL， Video Coding Layer）
    VCL输出的是原始数据比特流（SODB，String of data bits），表示H.264的语法元素编码完成后的实际的原始二进制码流。SODB通常不能保证字节对齐,故需要补齐为原始字节序列负荷（RBSP，Raw Byte Sequence Payload）。
* 网络提取层（NAL，Network Abstraction Layer）
    NAL层实际上就是最终输出的H.264码流，它是由一个个NALU组成的，每个NALU包括一组对应于视频编码数据的NAL头信息和一个原始字节序列负荷（RBSP，Raw Byte Sequence Payload）。
    
```
RBSP = SODB + RBSP trailing bits
NALU = NAL header(1 byte) + RBSP
H.264 = Start Code Prefix(3 bytes) + NALU + Start Code Prefix(3 bytes) + NALU +…
```


H.264码流解构图如下：
![](http://image.sweetm.top//18-6-30/48005295.jpg)
### Start Code
----
每个NALU之间由起始码（Start Code Prefix）分隔，起始码分为两种：0x000001(3 bytes) or 0x00000001(4 bytes). 如果NALU 对应的Slice 为一帧的开始，则用4 字节表示，即0x00000001；否则用3 字节表示，0x000001.NALU针对起始码设计了防止冲突机制，如果出现连续的0x000000，0x000001,0x000002,0x000003时，会在两个0之间插入03，如下：

```
0x00 00 00 -> 0x00 00 03 00
0x00 00 01 -> 0x00 00 03 01
0x00 00 02 -> 0x00 00 03 02
0x00 00 03 -> 0x00 00 03 03

```

### NAL header
---
一个NALU就是编码后的一帧数据。NAL header是1byte  NAL header头的格式 ：
![](http://image.sweetm.top//18-6-30/23450499.jpg)

* forbidden_bit(1bit) + nal_reference_bit(2bit) + nal_unit_type(5bit)
    * forbidden_zero_bit(1 bit) 禁止位，如果有语法冲突，则为 1。当网络识别此单元存在比特错误时，可将其设为 1，以便接收方丢掉该单元。
    * nal_ref_idc(2 bit)指示当前NAL的优先级，取值范围为0~3，值越高，表示当前NAL越重要。H.264规定，如果当前NAL是序列参数集，或是图像参数等，该值必须大于0.比如nal_unit_type等于5时，nal_ref_idc大于0；nal_unit_type等于6,9,10,11或12时，nal_ref_idc等于0；
    * nal_unit_type表示当前NALU的类型，表格如下：


### 表 nal_unit_type 
| nal_unit_type | NAL类型  | C |
| --- | --- | --- |
|  0  | 未使用 |      |
|  1  | 未使用Data Partitioning、非IDR图像的Slice |   2，3，4   |
|  2  | 使用Data Partitioning、且为Slice A |   2   |
|  3  | 使用Data Partitioning、且为Slice B |   3   |
|  4  | 使用Data Partitioning、且为Slice C |   4   |
|  5  | IDR图像中的Slice|   2，3   |
|  6  | 补充增强信息单元（SEI）|   5   |
|  7  | 序列参数集（Sequence Parameter Set,SPS）|   0   |
|  8  | 图像参数集（Picture Parameter Set,PPS）|   1   |
|  9  | 分界符|   6   |
|  10 | 序列结束|   7   |
|  11 | 码流结束|   8   |
|  12  | 填充|   9   |
|  13...23  | 保留|      |
|  24...31  | 未使用|      |
        

　　nal_unit_type=5时，表示当前NAL是IDR图像的一个片，此时，IDR图像中的每个片的nal_unit_type都应该等于5。
　一般H.264原始码流是以SPS->PPS->SEI->IDR->SLICE->SLICE…开头的。 
　GOP即Group of picture(图像组)，指两个I帧之间的距离。即几秒有一个关键帧。一般在2、3秒之间。
### 图像示意图
![](http://image.sweetm.top//18-7-3/35852414.jpg)
　
　　H.264有两种封装模式：
　　（1）annexb模式：传统模式，有start code， SPS和PPS是在ES中；
　　（2）mp4模式：没有start code，SPS和PPS是封装在container中，每一个frame前面是这个frame的长度；
　　SPS的头部是0x67，PPS的头部是0x68，要保持对数据的敏感性。
> 判断能否都丢帧的依据是，根据NALU包的优先级字节，如果优先级为0，则可以丢弃，如果是IDR、SPS、PPS时，优先级会大于0。

* SPS:Sequence Parameter Set 序列参数集，H.264码流第一个 NALU
* PPS:Picture Parameter Set图像参数集，H.264码流第二个 NALU
* IDR帧:IDR帧属于I 帧。解码器收到IDR frame时，将所有的参考帧队列丢弃 ，这点是所有I
帧共有的特性，但是收到IDR帧时，解码器另外需要做的工作就是：把所有的PPS和SPS参数进行更新。由此可见，在编码器端，每发一个 IDR，就相应地发一个 PPS&SPS_nal_unit
* I帧:帧内编码帧是一种自带全部信息的独立帧，无需参考其它图像便可独立进行解码，视频序列中的第一个帧始终都是I帧。
* P帧:前向预测编码帧
* B帧：双向预测内插编码帧





µ