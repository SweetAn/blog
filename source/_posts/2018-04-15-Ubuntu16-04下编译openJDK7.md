---
title: Ubuntu16.04ä¸‹ç¼–è¯‘openJDK7
date: 2018-04-15 11:46:24
tags: 
- java
- openJDK
categories: 
- ç¼–ç¨‹è¯­è¨€
- javaç¼–è¯‘
---
æœ¬æ¥æ˜¯çœ‹ ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ç¬¬äºŒç‰ˆçš„ï¼Œé‡Œé¢çš„ç¬¬ä¸€ç« å°±æ˜¯ç¼–è¯‘openJDK7ï¼Œæ‰€ä»¥å…´è‡´å‹ƒå‹ƒçš„åœ¨æˆ‘çš„macç³»ç»Ÿä¸Šç¼–è¯‘ï¼Œä¸è¿‡æœ‰å¥½å¤šé—®é¢˜ğŸ˜‚ï¼Œæ‰€æœ‰è£…äº†ä¸ªè™šæ‹Ÿæœºä½¿ç”¨äº†Ubuntuç¼–è¯‘äº†openJDk7 ï¼ŒåŸå› æ˜¯èµ„æ–™å¤šã€‚
ä¸‹é¢å°±å¼€å§‹ä¸€ä¸€åˆ—å‡ºç»è¿‡å’Œé‡åˆ°çš„å‘åŠè§£å†³åŠæ³•å§ï¼

## é¦–å…ˆï¼Œå½“ç„¶æ˜¯ä¸‹è½½openJdk7æºç äº†
ä½¿ç”¨ Mercurial,å› ä¸ºopenJdk7 æ˜¯ä½¿ç”¨è¿™ä¸ªç‰ˆæœ¬æ§åˆ¶ç®¡ç†çš„

```
sudo apt-get install mercurial
```
æ¥ä¸‹æ¥å°±æ˜¯ä¸‹è½½æºç äº†

```
hg clone http://hg.openjdk.java.net/jdk7u/jdk7u-dev
cd jdk7u-dev
chmod 755 get_source.sh
./get_source.sh
```
ç»™ä½ å»ºè®®ï¼Œå¦‚æœæœ‰äº‘æœåŠ¡å™¨ï¼Œå»ºè®®åœ¨ä¸Šé¢ä¸‹è½½å®Œï¼Œåœ¨å¯¼å…¥æœ¬åœ°ï¼Œæˆ‘çš„æœ¬åœ°ç½‘ç»œä¸‹è½½ä¸äº†ï¼ŒåŸå› å¤§å®¶éƒ½æ‡‚ğŸ˜­

### ç¼–è¯‘çš„è¿‡ç¨‹

å¤§éƒ¨åˆ†æ˜¯æ‘˜æŠ„

```
sudo apt-get install build-essential gawk m4  libasound2-dev libcups2-dev libxrender-dev xorg-dev xutils-dev x11proto-print-dev binutils libmotif3 libmotif-dev ant
```

* jdk-6u45-linux-x64.bin,èµ„æºè‡ªå·±æœï¼Œå®‰è£…åœ¨æœ¬æœºã€‚

* libmotif3ä¹Ÿä¸èƒ½ç›´æ¥å®‰è£…ï¼Œ[ä¸‹è½½åœ°å€](https://launchpad.net/ubuntu/xenial/amd64/libmotif3/2.3.4-8ubuntu1)
* ç¯å¢ƒå˜é‡è®¾ç½®  enviroment.sh ,make sanityæ£€æŸ¥
  ä½¿ç”¨æ–¹æ³•ï¼šå°†è¿™ä¸ªæ–‡ä»¶ï¼Œæ”¾åˆ°ä½ ä¸‹è½½å¥½çš„æºç æ ¹ç›®å½•ä¸‹ï¼Œæœ‰makeæ–‡ä»¶çš„é‚£ä¸ªæ–‡ä»¶å¤¹ï¼Œæˆ‘åœ¨è¿™è½¬äº†å¥½å‡ åœˆï¼Œ
  1ã€ç¼–è¯‘å‰è¦ç”¨ source environment.sh æ˜¯è¿™ä¸ªæ–‡ä»¶ç”Ÿæ•ˆ 
  2ã€ä½¿ç”¨ make sanity
å¦‚æœè¾“å‡ºæ˜¯Sanity check passedï¼Œåˆ™è¯æ˜æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥è¿›è¡Œmakeäº†

```
#!/bin/sh
# environment.sh
export LANG=C
export ALT_BOOTDIR=/usr/lib/java/jdk1.6.0_45
export ALLOW_DOWNLOADS=true
export HOTSPOT_BUILD_JOBS=4
export ALT_PARALLEL_COMPILE_JOBS=4
export SKIP_COMPARE_IMAGES=true
export USE_PRECOMPILED_HEADER=true

export BUILD_LANGTOOLS=true
#export BUILD_JAXP=false
#export BUILD_JAXWS=false
#export BUILD_CORBA=false
export BUILD_HOTSPORT=true
export BUILD_JDK=true

# export SKIP_DEBUG_BUILD=false
# export SKIP_FASTDEBUG_BUILD=true
# export DEBUG_NAME=debug

BUILD_DEPLOY=false
BUILD_INSTALL=false
export ALT_OUTPUTDIR=/home/mk/jdk7build
unset JAVA_HOME
unset CLASSPATH
unset LD_LIBRARY_PATH
```

## ç¼–è¯‘äº†

* è¾“å…¥make 2>&1 | tee $ALT_OUTPUTDIR/build.logè¿›è¡Œç¼–è¯‘
* è‹¥å‡ºç°ä»¥ä¸‹ä¿¡æ¯ï¼Œåˆ™è¯æ˜ç¼–è¯‘æˆåŠŸ

```
########################################################################
##### Leaving jdk for target(s) sanity all docs images             #####
########################################################################
##### Build time 00:04:29 jdk for target(s) sanity all docs images #####
########################################################################

-- Build times ----------
Target all_product_build
Start 2018-04-15 11:23:03
End   2018-04-15 11:27:43
00:00:03 corba
00:00:03 hotspot
00:00:02 jaxp
00:00:02 jaxws
00:04:29 jdk
00:00:01 langtools
00:04:40 TOTAL
-------------------------
```

## é”™è¯¯è§£å†³åŠæ³•

### é—®é¢˜ä¸€

```
/usr/include/x86_64-linux-gnu/sys/cdefs.h:42:0: note: this is the location of the previous definition
 #  define __LEAF , __leaf__
 ^
cc1plus: all warnings being treated as errors
/home/mk/jdk7up/jdk7/hotspot/make/linux/makefiles/vm.make:260: recipe for target 'precompiled.hpp.gch' failed
make[6]: *** [precompiled.hpp.gch] Error 1
make[6]: Leaving directory '/home/mk/jdk7build/hotspot/outputdir/linux_amd64_compiler2/product'
/home/mk/jdk7up/jdk7/hotspot/make/linux/makefiles/top.make:117: recipe for target 'the_vm' failed
make[5]: *** [the_vm] Error 2
make[5]: Leaving directory '/home/mk/jdk7build/hotspot/outputdir/linux_amd64_compiler2/product'
/home/mk/jdk7up/jdk7/hotspot/make/linux/Makefile:289: recipe for target 'product' failed
make[4]: *** [product] Error 2
make[4]: Leaving directory '/home/mk/jdk7build/hotspot/outputdir'
Makefile:180: recipe for target 'generic_build2' failed
make[3]: *** [generic_build2] Error 2
make[3]: Leaving directory '/home/mk/jdk7up/jdk7/hotspot/make'
Makefile:138: recipe for target 'product' failed
make[2]: *** [product] Error 2
make[2]: Leaving directory '/home/mk/jdk7up/jdk7/hotspot/make'
make/hotspot-rules.gmk:97: recipe for target 'hotspot-build' failed
make[1]: *** [hotspot-build] Error 2
make[1]: Leaving directory '/home/mk/jdk7up/jdk7'
Makefile:244: recipe for target 'build_product_image' failed
make: *** [build_product_image] Error 2
```
è§£å†³åŠæ³•ï¼š

```
åœ¨interfaceSupport.hppå¢åŠ 
#ifdef __LEAF
#undef __LEAF

#define __LEAF(result_type, header)                                  \
  TRACE_CALL(result_type, header)                                    \
  debug_only(NoHandleMark __hm;)                                     \
  /* begin of body */
#endif
```

### é—®é¢˜äºŒ

```
/usr/lib/java/jdk1.6.0_45/bin/idlj -J-XX:-PrintVMOptions -J-XX:+UnlockDiagnosticVMOptions -J-XX:-LogVMOutput -J-Xmx512m -J-Xms512m -J-XX:PermSize=32m -J-XX:MaxPermSize=160m -td "/home/mk/jdk7build/corba/gensrc" -i "../../../../src/share/classes/org/omg/PortableServer" -i "../../../../src/share/classes/org/omg/PortableInterceptor" -corba 3.0 -fall -pkgPrefix PortableServer org.omg ../../../../src/share/classes/org/omg/PortableServer/poa.idl
Error occurred during initialization of VM
Could not reserve enough space for object heap
Makefile:96: recipe for target '/home/mk/jdk7build/corba/gensrc/org/omg/PortableServer/CurrentHelper.java' failed
make[5]: *** [/home/mk/jdk7build/corba/gensrc/org/omg/PortableServer/CurrentHelper.java] Error 1
make[5]: Leaving directory '/home/mk/jdk7up/jdk7/corba/make/org/omg/sources'
Makefile:42: recipe for target 'build' failed
make[4]: *** [build] Error 1
make[4]: Leaving directory '/home/mk/jdk7up/jdk7/corba/make/org/omg'
Makefile:41: recipe for target 'build' failed
make[3]: *** [build] Error 1
make[3]: Leaving directory '/home/mk/jdk7up/jdk7/corba/make/org'
Makefile:166: recipe for target 'build' failed
make[2]: *** [build] Error 1
make[2]: Leaving directory '/home/mk/jdk7up/jdk7/corba/make'
make/corba-rules.gmk:42: recipe for target 'corba-build' failed
make[1]: *** [corba-build] Error 2
make[1]: Leaving directory '/home/mk/jdk7up/jdk7'
Makefile:244: recipe for target 'build_product_image' failed
```

è§£å†³åŠæ³•ï¼š æ–‡ä»¶ä¸­æœ‰ç©ºæ ¼


### é—®é¢˜ä¸‰

```
(cd  ./langtools/make && \
  make JDK_TOPDIR=/home/mk/jdk7up/jdk7/jdk JDK_MAKE_SHARED_DIR=/home/mk/jdk7up/jdk7/jdk/make/common/shared EXTERNALSANITYCONTROL=true SOURCE_LANGUAGE_VERSION=7 TARGET_CLASS_VERSION=7 MILESTONE=internal BUILD_NUMBER=b00 JDK_BUILD_NUMBER=b00 FULL_VERSION=1.7.0-internal-mk_2018_04_13_16_15-b00 PREVIOUS_JDK_VERSION=1.6.0 JDK_VERSION=1.7.0 JDK_MKTG_VERSION=7 JDK_MAJOR_VERSION=1 JDK_MINOR_VERSION=7 JDK_MICRO_VERSION=0 PREVIOUS_MAJOR_VERSION=1 PREVIOUS_MINOR_VERSION=6 PREVIOUS_MICRO_VERSION=0 ARCH_DATA_MODEL=64 COOKED_BUILD_NUMBER=0 ALT_OUTPUTDIR=/home/mk/jdk7up/jdk7/build/linux-amd64/langtools ALT_BOOTDIR=/NO_BOOTDIR all)
make[2]: Entering directory '/home/mk/jdk7up/jdk7/langtools/make'
JAVA_HOME=/NO_BOOTDIR ANT_OPTS=-Djava.io.tmpdir='/home/mk/jdk7up/jdk7/build/linux-amd64/langtools/build/ant-tmp' ant -Djdk.version=1.7.0 -Dfull.version='1.7.0-internal-mk_2018_04_13_16_15-b00'  -Dmilestone=internal -Dbuild.number=b00 -Djavac.target=7 -Djavac.source=7 -Dboot.java.home=/NO_BOOTDIR -Dimport.jdk=/home/mk/jdk7up/jdk7/jdk -Dbuild.dir=/home/mk/jdk7up/jdk7/build/linux-amd64/langtools/build -Ddist.dir=/home/mk/jdk7up/jdk7/build/linux-amd64/langtools/dist build
Error: JAVA_HOME is not defined correctly.
  We cannot execute /NO_BOOTDIR/bin/java
```
è§£å†³åŠæ³•ï¼š ç¯å¢ƒå˜é‡æ²¡æœ‰è®¾ç½®ï¼Œä¹Ÿå°±æ˜¯ï¼Œenvironment.sh  æ²¡æœ‰æ‰§è¡Œ source environment.sh 

### é—®é¢˜å››

```
g++ -DLINUX -D_GNU_SOURCE -DAMD64 -DPRODUCT -I. -I/home/mk/jdk7up/jdk7/hotspot/src/share/vm/prims -I/home/mk/jdk7up/jdk7/hotspot/src/share/vm -I/home/mk/jdk7up/jdk7/hotspot/src/cpu/x86/vm -I/home/mk/jdk7up/jdk7/hotspot/src/os_cpu/linux_x86/vm -I/home/mk/jdk7up/jdk7/hotspot/src/os/linux/vm -I/home/mk/jdk7up/jdk7/hotspot/src/os/posix/vm -I../generated -DHOTSPOT_RELEASE_VERSION="\"21.0-b17\"" -DHOTSPOT_BUILD_TARGET="\"product\"" -DHOTSPOT_BUILD_USER="\"mk\"" -DHOTSPOT_LIB_ARCH=\"amd64\" -DJRE_RELEASE_VERSION="\"1.7.0-internal-mk_2018_04_13_16_21-b00\"" -DHOTSPOT_VM_DISTRO="\"OpenJDK\"" -DTARGET_OS_FAMILY_linux -DTARGET_ARCH_x86 -DTARGET_ARCH_MODEL_x86_64 -DTARGET_OS_ARCH_linux_x86 -DTARGET_OS_ARCH_MODEL_linux_x86_64 -DTARGET_COMPILER_gcc -DCOMPILER2 -DCOMPILER1 -fPIC -fno-rtti -fno-exceptions -D_REENTRANT -fcheck-new -fvisibility=hidden -m64 -pipe -O3 -fno-strict-aliasing -DVM_LITTLE_ENDIAN -D_LP64=1 -fno-omit-frame-pointer -Werror -Wpointer-arith -Wsign-compare    -c -MMD -MP -MF ../generated/dependencies/dump_x86_64.o.d -o dump_x86_64.o /home/mk/jdk7up/jdk7/hotspot/src/cpu/x86/vm/dump_x86_64.cpp
cc1plus: all warnings being treated as errors
```

è§£å†³åŠæ³•ï¼š

```
åœ¨hotspot/make/makefiles/gcc.make ä¸­ï¼ŒæŠŠ -Werror é€‰é¡¹å»æ‰ã€‚
/home/mk/jdk7up/jdk7/hotspot/make/linux/makefiles/gcc.make
```

### é—®é¢˜äº”

```
-ljvm  -lc
gcc: error: unrecognized command line option '-mimpure-text'
../../common/Library.gmk:221: recipe for target '/home/mk/jdk7build/lib/amd64/libverify.so' failed
```
è§£å†³åŠæ³•ï¼š

```
/home/mk/jdk7up/jdk7/jdk/make/common/shared/Compiler-gcc.gmk
 åœ¨æ–‡ä»¶é‡Œçš„ç¬¬70è¡Œ
  #SHARED_LIBRARY_FLAG = -shared -mimpure-text
  æ”¹ä¸º SHARED_LIBRARY_FLAG = -shared

```

### é—®é¢˜å…­

```
Error: time is more than 10 years from present: 1136059200000
java.lang.RuntimeException: time is more than 10 years from present: 1136059200000
	at build.tools.generatecurrencydata.GenerateCurrencyData.makeSpecialCaseEntry(GenerateCurrencyData.java:285)
	at build.tools.generatecurrencydata.GenerateCurrencyData.buildMainAndSpecialCaseTables(GenerateCurrencyData.java:225)
	at build.tools.generatecurrencydata.GenerateCurrencyData.main(GenerateCurrencyData.java:154)
```
è§£å†³åŠæ³•

```
# ä¿®æ”¹CurrencyData.propertiesï¼ˆè·¯å¾„ï¼šjdk/src/share/classes/java/util/CurrencyData.propertiesï¼‰
ä¿®æ”¹108è¡Œ
AZ=AZM;2009-12-31-20-00-00;AZN
ä¿®æ”¹381è¡Œ
MZ=MZM;2009-06-30-22-00-00;MZN
ä¿®æ”¹443è¡Œ
RO=ROL;2009-06-30-21-00-00;RON
ä¿®æ”¹535è¡Œ
TR=TRL;2009-12-31-22-00-00;TRY
ä¿®æ”¹561è¡Œ
VE=VEB;2009-01-01-04-00-00;VEF

```

### é—®é¢˜ä¸ƒ

```
 make[5]: *** [/home/lichengwu/openjdk7/build/linux-amd64/lib/amd64/libjsoundalsa.so] Error 1
```
è§£å†³åŠæ³•ï¼š

```
 ln -s build/linux-amd64/lib/amd64/libjsound.so build/linux-amd64/lib/amd64/libjsoundalsa.so
 ln å‘½ä»¤è§£å†³ä¸äº†ï¼Œä½¿ç”¨ cpå‘½ä»¤
```




