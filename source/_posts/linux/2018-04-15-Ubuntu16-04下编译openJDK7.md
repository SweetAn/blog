---
title: Ubuntu16.04下编译openJDK7
date: 2018-04-15 11:46:24
tags: 
- java
- openJDK
categories: 
- 编程语言
- java编译
---
本来是看 《深入理解Java虚拟机》第二版的，里面的第一章就是编译openJDK7，所以兴致勃勃的在我的mac系统上编译，不过有好多问题😂，所有装了个虚拟机使用了Ubuntu编译了openJDk7 ，原因是资料多。
下面就开始一一列出经过和遇到的坑及解决办法吧！

## 首先，当然是下载openJdk7源码了
使用 Mercurial,因为openJdk7 是使用这个版本控制管理的

```
sudo apt-get install mercurial
```
接下来就是下载源码了

```
hg clone http://hg.openjdk.java.net/jdk7u/jdk7u-dev
cd jdk7u-dev
chmod 755 get_source.sh
./get_source.sh
```
给你建议，如果有云服务器，建议在上面下载完，在导入本地，我的本地网络下载不了，原因大家都懂😭

### 编译的过程

大部分是摘抄

```
sudo apt-get install build-essential gawk m4  libasound2-dev libcups2-dev libxrender-dev xorg-dev xutils-dev x11proto-print-dev binutils libmotif3 libmotif-dev ant
```

* jdk-6u45-linux-x64.bin,资源自己搜，安装在本机。

* libmotif3也不能直接安装，[下载地址](https://launchpad.net/ubuntu/xenial/amd64/libmotif3/2.3.4-8ubuntu1)
* 环境变量设置  enviroment.sh ,make sanity检查
  使用方法：将这个文件，放到你下载好的源码根目录下，有make文件的那个文件夹，我在这转了好几圈，
  1、编译前要用 source environment.sh 是这个文件生效 
  2、使用 make sanity
如果输出是Sanity check passed，则证明检查通过，可以进行make了

```
#!/bin/sh
# environment.sh
export LANG=C
export ALT_BOOTDIR=/usr/lib/java/jdk1.6.0_45
export ALLOW_DOWNLOADS=true
export HOTSPOT_BUILD_JOBS=4
export ALT_PARALLEL_COMPILE_JOBS=4
export SKIP_COMPARE_IMAGES=true
export USE_PRECOMPILED_HEADER=true

export BUILD_LANGTOOLS=true
#export BUILD_JAXP=false
#export BUILD_JAXWS=false
#export BUILD_CORBA=false
export BUILD_HOTSPORT=true
export BUILD_JDK=true

# export SKIP_DEBUG_BUILD=false
# export SKIP_FASTDEBUG_BUILD=true
# export DEBUG_NAME=debug

BUILD_DEPLOY=false
BUILD_INSTALL=false
export ALT_OUTPUTDIR=/home/mk/jdk7build
unset JAVA_HOME
unset CLASSPATH
unset LD_LIBRARY_PATH
```

## 编译了

* 输入make 2>&1 | tee $ALT_OUTPUTDIR/build.log进行编译
* 若出现以下信息，则证明编译成功

```
########################################################################
##### Leaving jdk for target(s) sanity all docs images             #####
########################################################################
##### Build time 00:04:29 jdk for target(s) sanity all docs images #####
########################################################################

-- Build times ----------
Target all_product_build
Start 2018-04-15 11:23:03
End   2018-04-15 11:27:43
00:00:03 corba
00:00:03 hotspot
00:00:02 jaxp
00:00:02 jaxws
00:04:29 jdk
00:00:01 langtools
00:04:40 TOTAL
-------------------------
```

## 错误解决办法

### 问题一

```
/usr/include/x86_64-linux-gnu/sys/cdefs.h:42:0: note: this is the location of the previous definition
 #  define __LEAF , __leaf__
 ^
cc1plus: all warnings being treated as errors
/home/mk/jdk7up/jdk7/hotspot/make/linux/makefiles/vm.make:260: recipe for target 'precompiled.hpp.gch' failed
make[6]: *** [precompiled.hpp.gch] Error 1
make[6]: Leaving directory '/home/mk/jdk7build/hotspot/outputdir/linux_amd64_compiler2/product'
/home/mk/jdk7up/jdk7/hotspot/make/linux/makefiles/top.make:117: recipe for target 'the_vm' failed
make[5]: *** [the_vm] Error 2
make[5]: Leaving directory '/home/mk/jdk7build/hotspot/outputdir/linux_amd64_compiler2/product'
/home/mk/jdk7up/jdk7/hotspot/make/linux/Makefile:289: recipe for target 'product' failed
make[4]: *** [product] Error 2
make[4]: Leaving directory '/home/mk/jdk7build/hotspot/outputdir'
Makefile:180: recipe for target 'generic_build2' failed
make[3]: *** [generic_build2] Error 2
make[3]: Leaving directory '/home/mk/jdk7up/jdk7/hotspot/make'
Makefile:138: recipe for target 'product' failed
make[2]: *** [product] Error 2
make[2]: Leaving directory '/home/mk/jdk7up/jdk7/hotspot/make'
make/hotspot-rules.gmk:97: recipe for target 'hotspot-build' failed
make[1]: *** [hotspot-build] Error 2
make[1]: Leaving directory '/home/mk/jdk7up/jdk7'
Makefile:244: recipe for target 'build_product_image' failed
make: *** [build_product_image] Error 2
```
解决办法：

```
在interfaceSupport.hpp增加
#ifdef __LEAF
#undef __LEAF

#define __LEAF(result_type, header)                                  \
  TRACE_CALL(result_type, header)                                    \
  debug_only(NoHandleMark __hm;)                                     \
  /* begin of body */
#endif
```

### 问题二

```
/usr/lib/java/jdk1.6.0_45/bin/idlj -J-XX:-PrintVMOptions -J-XX:+UnlockDiagnosticVMOptions -J-XX:-LogVMOutput -J-Xmx512m -J-Xms512m -J-XX:PermSize=32m -J-XX:MaxPermSize=160m -td "/home/mk/jdk7build/corba/gensrc" -i "../../../../src/share/classes/org/omg/PortableServer" -i "../../../../src/share/classes/org/omg/PortableInterceptor" -corba 3.0 -fall -pkgPrefix PortableServer org.omg ../../../../src/share/classes/org/omg/PortableServer/poa.idl
Error occurred during initialization of VM
Could not reserve enough space for object heap
Makefile:96: recipe for target '/home/mk/jdk7build/corba/gensrc/org/omg/PortableServer/CurrentHelper.java' failed
make[5]: *** [/home/mk/jdk7build/corba/gensrc/org/omg/PortableServer/CurrentHelper.java] Error 1
make[5]: Leaving directory '/home/mk/jdk7up/jdk7/corba/make/org/omg/sources'
Makefile:42: recipe for target 'build' failed
make[4]: *** [build] Error 1
make[4]: Leaving directory '/home/mk/jdk7up/jdk7/corba/make/org/omg'
Makefile:41: recipe for target 'build' failed
make[3]: *** [build] Error 1
make[3]: Leaving directory '/home/mk/jdk7up/jdk7/corba/make/org'
Makefile:166: recipe for target 'build' failed
make[2]: *** [build] Error 1
make[2]: Leaving directory '/home/mk/jdk7up/jdk7/corba/make'
make/corba-rules.gmk:42: recipe for target 'corba-build' failed
make[1]: *** [corba-build] Error 2
make[1]: Leaving directory '/home/mk/jdk7up/jdk7'
Makefile:244: recipe for target 'build_product_image' failed
```

解决办法： 文件中有空格


### 问题三

```
(cd  ./langtools/make && \
  make JDK_TOPDIR=/home/mk/jdk7up/jdk7/jdk JDK_MAKE_SHARED_DIR=/home/mk/jdk7up/jdk7/jdk/make/common/shared EXTERNALSANITYCONTROL=true SOURCE_LANGUAGE_VERSION=7 TARGET_CLASS_VERSION=7 MILESTONE=internal BUILD_NUMBER=b00 JDK_BUILD_NUMBER=b00 FULL_VERSION=1.7.0-internal-mk_2018_04_13_16_15-b00 PREVIOUS_JDK_VERSION=1.6.0 JDK_VERSION=1.7.0 JDK_MKTG_VERSION=7 JDK_MAJOR_VERSION=1 JDK_MINOR_VERSION=7 JDK_MICRO_VERSION=0 PREVIOUS_MAJOR_VERSION=1 PREVIOUS_MINOR_VERSION=6 PREVIOUS_MICRO_VERSION=0 ARCH_DATA_MODEL=64 COOKED_BUILD_NUMBER=0 ALT_OUTPUTDIR=/home/mk/jdk7up/jdk7/build/linux-amd64/langtools ALT_BOOTDIR=/NO_BOOTDIR all)
make[2]: Entering directory '/home/mk/jdk7up/jdk7/langtools/make'
JAVA_HOME=/NO_BOOTDIR ANT_OPTS=-Djava.io.tmpdir='/home/mk/jdk7up/jdk7/build/linux-amd64/langtools/build/ant-tmp' ant -Djdk.version=1.7.0 -Dfull.version='1.7.0-internal-mk_2018_04_13_16_15-b00'  -Dmilestone=internal -Dbuild.number=b00 -Djavac.target=7 -Djavac.source=7 -Dboot.java.home=/NO_BOOTDIR -Dimport.jdk=/home/mk/jdk7up/jdk7/jdk -Dbuild.dir=/home/mk/jdk7up/jdk7/build/linux-amd64/langtools/build -Ddist.dir=/home/mk/jdk7up/jdk7/build/linux-amd64/langtools/dist build
Error: JAVA_HOME is not defined correctly.
  We cannot execute /NO_BOOTDIR/bin/java
```
解决办法： 环境变量没有设置，也就是，environment.sh  没有执行 source environment.sh 

### 问题四

```
g++ -DLINUX -D_GNU_SOURCE -DAMD64 -DPRODUCT -I. -I/home/mk/jdk7up/jdk7/hotspot/src/share/vm/prims -I/home/mk/jdk7up/jdk7/hotspot/src/share/vm -I/home/mk/jdk7up/jdk7/hotspot/src/cpu/x86/vm -I/home/mk/jdk7up/jdk7/hotspot/src/os_cpu/linux_x86/vm -I/home/mk/jdk7up/jdk7/hotspot/src/os/linux/vm -I/home/mk/jdk7up/jdk7/hotspot/src/os/posix/vm -I../generated -DHOTSPOT_RELEASE_VERSION="\"21.0-b17\"" -DHOTSPOT_BUILD_TARGET="\"product\"" -DHOTSPOT_BUILD_USER="\"mk\"" -DHOTSPOT_LIB_ARCH=\"amd64\" -DJRE_RELEASE_VERSION="\"1.7.0-internal-mk_2018_04_13_16_21-b00\"" -DHOTSPOT_VM_DISTRO="\"OpenJDK\"" -DTARGET_OS_FAMILY_linux -DTARGET_ARCH_x86 -DTARGET_ARCH_MODEL_x86_64 -DTARGET_OS_ARCH_linux_x86 -DTARGET_OS_ARCH_MODEL_linux_x86_64 -DTARGET_COMPILER_gcc -DCOMPILER2 -DCOMPILER1 -fPIC -fno-rtti -fno-exceptions -D_REENTRANT -fcheck-new -fvisibility=hidden -m64 -pipe -O3 -fno-strict-aliasing -DVM_LITTLE_ENDIAN -D_LP64=1 -fno-omit-frame-pointer -Werror -Wpointer-arith -Wsign-compare    -c -MMD -MP -MF ../generated/dependencies/dump_x86_64.o.d -o dump_x86_64.o /home/mk/jdk7up/jdk7/hotspot/src/cpu/x86/vm/dump_x86_64.cpp
cc1plus: all warnings being treated as errors
```

解决办法：

```
在hotspot/make/makefiles/gcc.make 中，把 -Werror 选项去掉。
/home/mk/jdk7up/jdk7/hotspot/make/linux/makefiles/gcc.make
```

### 问题五

```
-ljvm  -lc
gcc: error: unrecognized command line option '-mimpure-text'
../../common/Library.gmk:221: recipe for target '/home/mk/jdk7build/lib/amd64/libverify.so' failed
```
解决办法：

```
/home/mk/jdk7up/jdk7/jdk/make/common/shared/Compiler-gcc.gmk
 在文件里的第70行
  #SHARED_LIBRARY_FLAG = -shared -mimpure-text
  改为 SHARED_LIBRARY_FLAG = -shared

```

### 问题六

```
Error: time is more than 10 years from present: 1136059200000
java.lang.RuntimeException: time is more than 10 years from present: 1136059200000
	at build.tools.generatecurrencydata.GenerateCurrencyData.makeSpecialCaseEntry(GenerateCurrencyData.java:285)
	at build.tools.generatecurrencydata.GenerateCurrencyData.buildMainAndSpecialCaseTables(GenerateCurrencyData.java:225)
	at build.tools.generatecurrencydata.GenerateCurrencyData.main(GenerateCurrencyData.java:154)
```
解决办法

```
# 修改CurrencyData.properties（路径：jdk/src/share/classes/java/util/CurrencyData.properties）
修改108行
AZ=AZM;2009-12-31-20-00-00;AZN
修改381行
MZ=MZM;2009-06-30-22-00-00;MZN
修改443行
RO=ROL;2009-06-30-21-00-00;RON
修改535行
TR=TRL;2009-12-31-22-00-00;TRY
修改561行
VE=VEB;2009-01-01-04-00-00;VEF

```

### 问题七

```
 make[5]: *** [/home/lichengwu/openjdk7/build/linux-amd64/lib/amd64/libjsoundalsa.so] Error 1
```
解决办法：

```
 ln -s build/linux-amd64/lib/amd64/libjsound.so build/linux-amd64/lib/amd64/libjsoundalsa.so
 ln 命令解决不了，使用 cp命令
```




