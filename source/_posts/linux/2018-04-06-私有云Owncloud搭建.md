---
title: 私有云Owncloud搭建
date: 2018-04-06 22:16:12
tags: 
- Linux
- 私有云
- 文件服务器
categories: 
- 服务器
- 文件服务器
---

### owncloud
OwnCloud是一个基于Linux系统的开源云项目，允许用户建立自己的个人云服务器，目前功能包括文件分享、音乐存储、日历、联系人和书签共享等等。OwnCloud业务人员称，“相比Dropbox和box.net，我们提供的服务更实惠，更安全，更方便管理，灵活性更强，十分适合商业用途。OwnCloud用户还可在自己的硬件和存储设备上实现文件同步和共享服务。

[Owncould下载网址](https://owncloud.org/download/#instructions-server)
![](https://sweetm-1256061026.cos.ap-beijing.myqcloud.com/Jietu20180406-221911.jpg)

本次搭建采用了 nginx+owncloud+php5

#### 一、根据上面的网址下载 ownCould 安装包
解压开压缩包，并且将解压后的文件移动到对应的文件夹 想要存放 website的目录 /data/website/owncloud

```
    tar -jxvf owncloud-10.0.7.tar.bz2
    mv owncloud /data/website/owncloud
```

上面目录owncloud 需要配置权限 

```
drwxr-x--- 14 root www-data 4096 4月   6 21:45 owncloud
```
官方摘的权限配置 需要修改
You can find your HTTP user in your HTTP server configuration files. Or you can use PHP Version and Information (Look for the User/Group line).

```
The HTTP user and group in Debian/Ubuntu is www-data.
The HTTP user and group in Fedora/CentOS is apache.
The HTTP user and group in Arch Linux is http.
The HTTP user in openSUSE is wwwrun, and the HTTP group is www.
```

可以使用 下面的命令 检查 用户是否有访问，你设置磁盘路径的权限

```
sudo -u www-data  ls -la /media/pi/pi-data/owncloud
```

#### 二、配置nginx 代理
```
upstream php-handler {
    server    127.0.0.1:9000;
    #server    unix:/var/run/php5-fpm.sock;
}

server {
    listen    81;
    server_name    www.test.com;
    # Path to the root of your installation
    root    /data/website/owncloud;
    index index.html index.htm index.php;
    # set max upload size
    client_max_body_size    10G;
    fastcgi_buffers    64    4K;
    # Disable gzip to avoid the removal of the ETag header
    gzip    off;
    # Uncomment if your server is build with the ngx_pagespeed module
    # This module is currently not supported.
    #pagespeed    off;
    rewrite    ^/caldav(.*)$    /remote.php/caldav$1 redirect;
    rewrite    ^/carddav(.*)$    /remote.php/carddav$1 redirect;
    rewrite    ^/webdav(.*)$    /remote.php/webdav$1 redirect;
    index    index.php;
    error_page    403    /core/templates/403.php;
    error_page    404    /core/templates/404.php;
    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }
    location ~ ^/(?:\.htaccess|data|config|db_structure\.xml|README){
        deny all;
    }
    location / {
        # The following 2 rules are only needed with webfinger
        rewrite ^/.well-known/host-meta /public.php?service=host-meta last;
        rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json last;
        rewrite ^/.well-known/carddav /remote.php/carddav/ redirect;
        rewrite ^/.well-known/caldav /remote.php/caldav/ redirect;
        rewrite ^(/core/doc/[^\/]+/)$ $1/index.html;
"owncould.conf" 56L, 2123C                                                            1,1          顶端
        rewrite ^/.well-known/caldav /remote.php/caldav/ redirect;
        rewrite ^(/core/doc/[^\/]+/)$ $1/index.html;
        try_files $uri $uri/ /index.php;
    }
    location ~ \.php(?:$|/) {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_pass php-handler;
    }
    # Optional: set long EXPIRES header on static assets
    location ~* \.(?:jpg|jpeg|gif|bmp|ico|png|css|js|swf)$ {
          expires 30d;
          # Optional: Don't log access to assets
            access_log off;
    }
}
```

#### 三、剩下的就是配置PHP 环境了

Required
  PHP Version
  PHP >= 5.6 (ideally 7.0 or above)


搭配需要的PHP环境 推荐 7.0

```
apt-get install -y libsmbclient-dev libssh2-1-dev openssl php5-imagick \
    php5-common php5-curl php5-dev php5-gd \
    php5-imap php5-intl php5-json php5-ldap \
    php5-mcrypt php5-mysql php5-pgsql php5-sqlite
```


提示：如果获取不到php 环境变量
修改目录  /etc/php5/fpm/pool.d/www.conf

```
; Pass environment variables like LD_LIBRARY_PATH. All $VARIABLEs are taken from
; the current environment.
; Default Value: clean env
env[HOSTNAME] = $HOSTNAME
env[PATH] = /usr/local/bin:/usr/bin:/bin
env[TMP] = /tmp
env[TMPDIR] = /tmp
env[TEMP] = /tmp

```

### 放一张正常启动的图

![](https://sweetm-1256061026.cos.ap-beijing.myqcloud.com/Jietu20180406-231644.jpg)




